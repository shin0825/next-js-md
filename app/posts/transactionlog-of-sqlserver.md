---
title: (仮)SQLServerのトランザクションログについて
permalink: transactionlog-of-sqlserver
date: '2021-03-11'
category: 技術
tag:
- SQLServer
---

SQLServerを使っていく中でたまにトランザクションログにまつわるトラブルに見舞われることがある。
トランザクションログが何者かを知り、障害が起こらないような設定を把握したい。

## トランザクションログとは

### 概要

SQLServerの稼働中に行われた、
- 発生したトランザクション
- 加えられた変更
これらの記録をデータベース単位で保存したものである。

### ファイル

- 拡張子は .ldf である。
- 大抵はデータベースごとに一つのファイルが作成される。
- 内部的に、仮装ログファイル というセグメントが複数ある。
  - そのサイズはSQLServerにより自動的に管理される。
  - 領域には３つのステータスがある。
    - 未使用
    - 使用中
    - 再利用可能
  - 記録時に、ステータスが使用中の領域しかない場合、ログファイルが拡張される。
  - ログファイルを拡張せずに利用したい場合は、トランザクションログの領域を切り捨て、再利用可能領域を確保する必要がある。
  - なお切り捨てが行われてもファイルの容量は変わらない。
    - ログファイルの圧縮を行い、サイズを縮小する必要がある。
- トランザクションログはインデックスの再構築やバッチ処理などの膨大なクエリを発行した場合、一瞬でサイズが増えるので注意。
### 何に使うのか

- バックアップとしてリストア時に利用する。
- 内部的には、データがCOMMITされるまでの間の記録場所となる。
  - CHECKPOINTという処理が行われるごとに、データファイルという場所に書き換えられ、トランザクションログの領域は再利用可能となる。
  - データファイルは、完全に確定したデータが保存されるファイルであり、バックアップとしてはメインのファイルとなる。
    - トランザクションログは、障害発生直前までのデータが記録されているので、データ消失が許されない場合に必要となる。

## 復旧モデルとは

- トランザクションログをどのように扱うのか設定するもので、大まかに２つ（本当は３つだけど難しいので……。）
  - 単純（シンプル）モード
  - 完全モード

### 単純モード

ファイルが肥大化しないので、トランザクションログの管理が容易になる。（というかほぼ不要になる）

- トランザクションログにデータを残さない設定。
  - CHECKPOINT発生ごとに利用していた領域を再利用可能にする。
- 当然リストアはできない。

### 完全モード

データファイル、トランザクションログを全て保存されているので、障害時の状態で復元可能。

- トランザクションログはバックアップのタイミングで再利用可能状態になる。
  - バックアップを運用上スケジューリングしておく必要がある。
  - 先にも述べたが、実行される処理やクエリに合わせてファイルが肥大化し容量を使い切らないよう監視やバックアップを行う必要がある。


## 参考

[トランザクション ログ (SQL Server)](https://docs.microsoft.com/ja-jp/sql/relational-databases/logs/the-transaction-log-sql-server?view=sql-server-ver15)

[復旧モデル (SQL Server)](https://docs.microsoft.com/ja-jp/sql/relational-databases/backup-restore/recovery-models-sql-server?view=sql-server-ver15)

[1分で分かる「トランザクションログ」の仕組み](https://www.atmarkit.co.jp/ait/articles/1610/31/news016.html)
